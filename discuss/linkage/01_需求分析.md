# 形状联动同步功能 - 需求分析

## 背景

当前系统支持通过"刻孔/溅铝"和"扩大/缩小"功能基于现有形状创建新的派生形状。但是，这些派生形状与原形状之间是**静态快照关系**，原形状发生变化时，派生形状不会自动同步更新。

## 核心需求

### 需求1：基础形状变化时派生形状自动同步

**当前行为**：
```
原形状 ──深拷贝──> 派生形状
    │
    └─> 修改原形状 ✗ 派生形状不受影响
```

**期望行为**：
```
原形状 ──引用关系──> 派生形状
    │
    └─> 修改原形状 ✓ 派生形状自动同步
```

**影响范围**：
- 顶点坐标（vertices）
- 缩放参数（zoom）
- 倒角配置（fillet）
- 图层信息（layer）- 可选
- 其他继承属性

### 需求2：倒角参数的继承覆盖机制

这是一个更细粒度的需求，针对倒角参数实现"智能继承"：

**默认状态：自动继承**
```
原形状.fillet = { type: "arc", radius: 5 }
                      ↓ 继承
派生形状.fillet = { type: "arc", radius: 5, inherited: true }

修改原形状.fillet.radius = 10
                      ↓ 自动同步
派生形状.fillet = { type: "arc", radius: 10, inherited: true }
```

**用户手动修改后：独立状态**
```
用户修改：派生形状.fillet.radius = 8
                      ↓ 标记为独立
派生形状.fillet = { type: "arc", radius: 8, inherited: false }

此后，原形状.fillet 如何变化，派生形状都保持 radius = 8
```

**关键特性**：
1. **默认继承**：新创建的派生形状自动跟随原形状变化
2. **手动覆盖**：用户修改后锁定为独立值
3. **可恢复继承**：提供UI按钮让用户重新启用继承
4. **状态可视化**：清晰显示哪些属性是继承的，哪些是独立的

### 需求3：安全性和易用性

**循环依赖防护**：
```
❌ 禁止：A 派生 B，B 派生 A
✓ 允许：A 派生 B，B 派生 C（线性依赖链）
```

**删除保护**：
```
用户尝试删除原形状
    ↓
系统提示："该形状有3个派生形状依赖它，确认删除？"
    ↓ 用户确认
选项1：同时删除所有派生形状
选项2：将派生形状转为独立形状
```

**依赖关系可视化**：
```
形状列表界面：
┌─ 多边形1 ───────────────┐
│  顶点: 0,0:10,0:10,10   │
│  [2个派生形状] ▼        │
└─────────────────────────┘
    ├─ 多边形1_扩大 (图层2)
    └─ 多边形1_via (图层3)
```

## 使用场景

### 场景1：设计迭代
```
设计师创建基础多边形，派生出多个不同图层的变体
    ↓
发现尺寸需要调整，修改基础多边形的顶点
    ↓
所有派生形状自动更新，无需手动逐个修改
```

### 场景2：参数化设计
```
创建一个圆形基础形状（通过圆心+半径定义）
    ↓
派生出刻孔层、溅铝层、保护层等多个形状
    ↓
调整圆形半径，所有相关层自动同步
```

### 场景3：部分定制
```
基础形状：倒角半径 = 5μm
    ↓ 派生
派生形状1：自动继承倒角 = 5μm
派生形状2：手动设置倒角 = 10μm（独立）
    ↓
修改基础形状倒角 = 8μm
    ↓ 结果
派生形状1：自动更新为 8μm ✓
派生形状2：保持为 10μm ✓
```

## 技术约束

### 前端约束
- 必须兼容现有的表单更新机制（`updateJSONFromForm`）
- 需要在UI中实时反映继承状态
- 不能显著增加页面渲染性能开销

### 后端约束
- YAML配置格式需要向后兼容
- 后端Python代码需要理解新的派生关系格式
- 生成GDS时需要正确展开派生形状

### 数据约束
- 配置文件大小不应显著增加
- 加载/保存速度不应明显下降
- 必须支持配置文件在不同版本间的迁移

## 非功能需求

### 性能要求
- 单次形状修改触发的同步更新应在100ms内完成
- 支持至少50个形状的项目（含派生关系）
- 依赖链深度不超过5层

### 可维护性要求
- 代码改动应模块化，避免散弹式修改
- 提供完整的单元测试覆盖
- 提供清晰的开发文档

### 用户体验要求
- 继承状态应清晰可见
- 操作应可撤销
- 错误提示应明确指出问题所在

## 优先级评估

| 功能 | 优先级 | 理由 |
|------|--------|------|
| 基础同步机制 | P0 | 核心功能，必须优先实现 |
| 循环依赖检测 | P0 | 保证系统稳定性 |
| 倒角继承覆盖 | P1 | 提升用户体验，但可后续迭代 |
| 删除保护 | P1 | 防止误操作，重要但非紧急 |
| 依赖关系可视化 | P2 | 锦上添花，可最后实现 |
| 性能优化 | P1 | 基础性能要求必须满足 |

## 后续讨论要点

1. 选择哪种技术方案实施？
2. 如何设计数据格式以平衡功能性和兼容性？
3. UI交互细节如何设计？
4. 如何分阶段实施以降低风险？

---

**文档版本**：v1.0
**创建时间**：2025-01-14
**作者**：Claude + User
**状态**：待审核
