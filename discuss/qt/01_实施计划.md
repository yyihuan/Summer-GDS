# Summer-GDS Qt GUI 改造实施计划

## 阶段1：Python 启动入口
- 目标：提供跨平台的 Python 启动入口（替代 shell 脚本），统一处理配置加载与参数解析。
- 工作项：
  - 设计新的 Python 入口模块（暂定 `web_gui/qt_launcher.py`），负责解析 CLI 参数、读取可选的 JSON 配置，并将合并后的参数交由 Qt 主窗口使用。
  - 更新仓库文档，说明新的启动方式（`uv run python -m web_gui.qt_launcher`）以及 legacy 脚本的状态。
- 可测试项：
  - 运行 `uv run python -m web_gui.qt_launcher --dry-run`（或等价调试选项）验证参数解析与配置合并逻辑。

## 阶段2：Flask 服务线程化与日志捕获
- 目标：
  - 让 Web 服务以受控线程运行，提供统一的生命周期管理接口。
  - 在不改动后端的前提下，将 `WARNING+` 级别日志桥接到 Qt/CLI 侧。
- 工作项：
  - 新建 `web_gui/server_worker.py`：基于 `werkzeug.serving.make_server` 封装 `ServerWorker`，实现 `start()`、`wait_ready(timeout)`、`shutdown()`，复用阶段1的 `LaunchOptions`。
  - 新建 `web_gui/log_bridge.py`：实现 `QueueLogHandler`，将 `WARNING+` 日志投递到线程安全队列；提供 `emit()` 和清理方法，后续阶段可转换为 Qt 信号。
  - 扩展 `web_gui/qt_launcher.py`：初始化 `ServerWorker` 与日志桥接器；在 `--headless` 流程中控制服务启动、信号注册及安全退出（捕获 `KeyboardInterrupt`）。
  - 保持现有 CLI 参数兼容，并确保无 Qt 依赖也可运行（后续阶段才加载 GUI 组件）。
- 可测试项：
  - CLI 下运行 `python -m web_gui.qt_launcher --headless`，验证服务器启动后可响应请求并在退出时正常关闭。
  - 触发 `logger.warning`、`logger.error`，确认消息进入日志队列并在 CLI 模式下输出。
  - 单元测试覆盖 `ServerWorker` 生命周期、日志队列投递和 Launcher 的非 Qt 执行路径。

## 阶段3：Qt 主窗口与嵌入式浏览器
- 目标：提供桌面化入口，窗口内嵌 Web GUI，并与服务线程共享生命周期；主界面底部保留约 1/5 的日志面板滚动显示 `WARNING/ERROR`。
- 工作项：
  - 构建 `QApplication`、`MainWindow`，在其中创建 `QWebEngineView` 指向 `http://host:port`，同时布局一个垂直 `QSplitter`，上层为浏览器区域，下层为占比约 20% 的日志窗口（支持滚动、只读展示）。
  - 监听服务线程准备完成后再加载页面；若启动失败弹出 `QMessageBox` 并安全退出。
  - 在 `closeEvent` 中调用 `ServerWorker.shutdown()`，确保 Flask 线程退出后应用结束；退出时清理日志桥接资源。
  - 使用 `LogBridge` + Qt `QTimer` 或信号机制刷新日志列表；提供 UI 内部追加方法，保障多条警告/错误依次展示。
  - 处理 `QWebEngineProfile.downloadRequested`，为 `Content-Disposition` 下载指定保存路径（或弹出对话框）并调用 `accept()`，恢复浏览器中的 GDS 下载体验。
- 可测试项：
  - 直接运行 `python -m web_gui.qt_launcher`（具备 Qt 依赖环境）确认窗口启动、页面可交互；关闭窗口后端口释放。
  - 制造 warning 场景，观察 Qt 内部提示是否与日志一致；滚动区域可上下滚动。
  - 自动化测试在无 Qt 依赖时应输出跳过说明；若环境允许，执行最小化 UI 实例化测试验证日志追加逻辑。

## 阶段4：用户体验与回退机制
- 目标：完善用户体验，保留纯 Web 模式选项，提升入口可用性。
- 工作项：
  - 在 Python 入口中提供 `--headless` 或 `--server-only` 选项，以保留旧的纯 Flask 行为。
  - 设计日志提示展示形式（状态栏、浮层或日志面板），确保不会干扰正常使用。
  - 根据需要调整 `web_gui/templates` 中的提示（若需同步显示）并在文档中说明差异。
- 可测试项：
  - 运行 `python -m web_gui.qt_launcher --headless`，确认仍可浏览器访问。
  - 多次启动/关闭 Qt 模式验证无残留进程，日志展示正常。

## 阶段5：回归验证与交付
- 目标：全量验证改造的稳定性，并完成交付资料。
- 工作项：
  - 执行 `python -m pytest tests/` 与关键端到端手动验证（导入配置、生成 GDS）。
  - 更新 `docs/` 与 README 中的启动说明、依赖要求、常见问题。
  - 整理变更记录，评估后续改进（如进一步日志上报、自动化测试）。
- 可测试项：
  - 覆盖常见用户场景：加载示例配置、生成文件、查看日志提示。
  - 审核文档步骤是否能顺利复现启动与关闭过程。
